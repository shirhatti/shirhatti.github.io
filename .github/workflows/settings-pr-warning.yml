name: Warn on settings changes

on:
  pull_request:
    paths:
      - '.github/settings.yml'
      - '.github/CODEOWNERS'
      - '.github/workflows/**'

permissions:
  pull-requests: write

jobs:
  warn:
    runs-on: ubuntu-latest
    steps:
      - name: Comment warning on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo
            const prNumber = context.payload.pull_request.number

            // Avoid duplicate comments on re-runs
            const comments = await github.rest.issues.listComments({
              owner, repo, issue_number: prNumber,
            })
            const marker = '<!-- settings-change-warning -->'
            if (comments.data.some(c => c.body.includes(marker))) return

            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber,
              body: [
                marker,
                '> [!CAUTION]',
                '> **This PR modifies repository configuration files.**',
                '>',
                '> Changes to `.github/settings.yml` are auto-applied by the',
                '> [repository-settings](https://github.com/repository-settings/app)',
                '> app once merged to `main`. Please review carefully.',
              ].join('\n'),
            })

            await github.rest.issues.addLabels({
              owner, repo, issue_number: prNumber,
              labels: ['infrastructure'],
            })
